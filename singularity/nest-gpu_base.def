Bootstrap: docker
From: nvcr.io/nvidia/cuda:11.6.2-devel-ubuntu20.04

%files
	.. /home/dev/installed_nest-gpu

%environment
	export USERNAME=dev
	# export PATH="/home/${USERNAME}/.local/bin:$PATH"
	
	# pyenv
	export PYENV_ROOT="/home/${USERNAME}/.pyenv"
	export PATH="${PYENV_ROOT}/shims:${PYENV_ROOT}/bin:${PATH}"
	
	# NEST-GPU
	export NEST_GPU=/usr/local/nestgpu
	export PYTHONPATH=${NEST_GPU}/lib/python3.9/site-packages:${PYTHONPATH}
	
	# Standard compiler
	export CC=gcc
	export CXX=g++
	export CUDA_PATH=/usr/local/cuda

	# OpenMPI
	export PATH=/opt/openmpi/bin:$PATH
	export LD_LIBRARY_PATH=/opt/openmpi/lib:$LD_LIBRARY_PATH
	export MANPATH=/opt/openmpi/share/man:$MANPATH

%post
	# Initial settings
	export DEBIAN_FRONTEND=noninteractive
	export DEBCONF_NOWARNINGS=yes
	export USERNAME=dev
	export CC=gcc
	export CXX=g++
	export CUDA_PATH=/usr/local/cuda
	export PATH=${CUDA_PATH}/bin:${PATH}
	ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
	
	# Install packages
	apt-get update
	apt-get install -y --no-install-recommends \
	sudo \
  ca-certificates \
	git \
	curl \
	wget \
	ssh \
	patch \
	less \
	make \
	cmake \
	gcc \
	g++ \
	libomp-dev \
	openssl \
	libssl-dev \
	libbz2-dev \
	libreadline-dev \
	libsqlite3-dev \
	libffi-dev \
	zlib1g-dev \
	liblzma-dev \
	libtool \
	libtool-bin \
	autoconf \
	automake \
	locales-all

	# Install openmpi 3.1.4
	export MPI_PATH=/opt/openmpi
	cd /tmp
	wget https://download.open-mpi.org/release/open-mpi/v3.1/openmpi-3.1.4.tar.gz
	tar -xvf openmpi-3.1.4.tar.gz
	cd openmpi-3.1.4
	mkdir $MPI_PATH
	./configure --prefix=$MPI_PATH --with-cuda=$CUDA_PATH
	make -j8
	make install
	export PATH=$MPI_PATH/bin:$PATH
	export LD_LIBRARY_PATH=$MPI_PATH/lib:$LD_LIBRARY_PATH
	export MANPATH=$MPI_PATH/share/man:$MANPATH

	# Install pyenv
	export PYTHON_VERSION="3.9.12"
	export PYENV_ROOT="/home/${USERNAME}/.pyenv"
	export PATH="${PYENV_ROOT}/shims:${PYENV_ROOT}/bin:${PATH}"
	git clone https://github.com/pyenv/pyenv.git ${PYENV_ROOT} \
		&& pyenv install -v ${PYTHON_VERSION} \
		&& pyenv global ${PYTHON_VERSION} \
		&& pyenv rehash

	# Install pip package
	pip install matplotlib mpi4py pynvml

	# Install nestgpu
	export NEST_GPU=/usr/local/nestgpu
	export PYTHONPATH=${NEST_GPU}/lib/python3.9/site-packages:${PYTHONPATH}
	# cd /home/${USERNAME}
	# git clone https://${GIT_USER:HOST}:${GIT_TOKEN:HOST}@github.com/${GIT_USER:HOST}/nest-gpu.git/ installed_nest-gpu
	cd /home/${USERNAME}/installed_nest-gpu
	./install.sh

%runscript
