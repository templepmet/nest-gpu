Bootstrap: docker
From: nvcr.io/nvidia/nvhpc:22.7-devel-cuda11.7-ubuntu22.04

%files
	../m4 /opt/nestgpu_install/
	../pythonlib /opt/nestgpu_install/
	../src /opt/nestgpu_install/
	../clean.sh /opt/nestgpu_install/
	../config.h.in /opt/nestgpu_install/
	../configure.ac /opt/nestgpu_install/
	../install.sh /opt/nestgpu_install/
	../Makefile.am /opt/nestgpu_install/
	../patch.sh /opt/nestgpu_install/
	../postinstall.sh /opt/nestgpu_install/
	
	../nest-simulator-3.3 /opt/nest_install

	../requirements.txt /opt

%environment
	# NVHPC
	. /etc/profile.d/lmod.sh
	module load nvhpc-byo-compiler
	export LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
	export LIBRARY_PATH=/opt/nvidia/hpc_sdk/Linux_x86_64/22.7/cuda/lib64:$LIBRARY_PATH
	export LIBRARY_PATH=/opt/nvidia/hpc_sdk/Linux_x86_64/22.7/math_libs/lib64:$LIBRARY_PATH

	# Standard compiler
	export CC=gcc
	export CXX=g++
	export CUDA_HOME=/opt/nvidia/hpc_sdk/Linux_x86_64/22.7/cuda

	# OpenMPI
	export OMPI_DIR=/opt/openmpi
	export PATH=$OMPI_DIR/bin:$PATH
	export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH
	export MANPATH=$OMPI_DIR/share/man:$MANPATH
	export OMPI_CC=$CC
	export OMPI_CXX=$CXX

	# pyenv
	export PYENV_ROOT=/opt/pyenv
	export PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH

	# NEST
	export NEST=/opt/nest
	export PATH=$NEST/bin:$PATH
	export PYTHONPATH=$NEST/lib/python3.10/site-packages:$PYTHONPATH

	# NEST-GPU
	export NEST_GPU=/opt/nestgpu
	export PYTHONPATH=$NEST_GPU/lib/python3.10/site-packages:$PYTHONPATH
	
	# matplotlib writable
	export MPLCONFIGDIR=/tmp/matplotlib

%post
	# Initial settings
	. /etc/profile.d/lmod.sh
	module load nvhpc-byo-compiler
	export LIBRARY_PATH=/opt/nvidia/hpc_sdk/Linux_x86_64/22.7/cuda/lib64:$LIBRARY_PATH
	export LIBRARY_PATH=/opt/nvidia/hpc_sdk/Linux_x86_64/22.7/math_libs/lib64:$LIBRARY_PATH

	export DEBIAN_FRONTEND=noninteractive
	export DEBCONF_NOWARNINGS=yes
	export CC=gcc
	export CXX=g++
	export OMPI_CC=$CC
	export OMPI_CXX=$CXX
	export CUDA_HOME=/opt/nvidia/hpc_sdk/Linux_x86_64/22.7/cuda
	
	# Install packages
	apt-get update
	apt-get install -y --no-install-recommends \
	libbz2-dev \
	libncurses-dev \
	libffi-dev \
	libreadline-dev \
	libssl-dev \
	libgsl-dev \
	libltdl-dev \
	libboost-dev \
	libiberty-dev \
	libibverbs-dev

	# # Install openmpi 3.1.4
	# export MPI_PATH=/opt/openmpi
	# cd /tmp
	# wget https://download.open-mpi.org/release/open-mpi/v3.1/openmpi-3.1.4.tar.gz
	# tar -xvf openmpi-3.1.4.tar.gz
	# cd openmpi-3.1.4
	# mkdir $MPI_PATH
	# ./configure --prefix=$MPI_PATH --with-cuda=$CUDA_HOME --with-verbs
	# make -j24
	# make install
	# export PATH=$MPI_PATH/bin:$PATH
	# export LD_LIBRARY_PATH=$MPI_PATH/lib:$LD_LIBRARY_PATH

	# # Install pyenv
	# export PYTHON_VERSION=3.10.7
	# export PYENV_ROOT=/opt/pyenv
	# export PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH
	# git clone https://github.com/pyenv/pyenv.git $PYENV_ROOT \
	# 	&& CFLAGS="-fPIC" pyenv install -v $PYTHON_VERSION \
	# 	&& pyenv global $PYTHON_VERSION \
	# 	&& pyenv rehash
	# pip install -r /opt/requirements.txt
	
	# # Install nest
	# export NEST=/opt/nest
	# cd /opt/nest_install
	# ./install.sh
	# chmod -R 777 $NEST

	# # Install nestgpu
	# export NEST_GPU=/opt/nestgpu
	# cd /opt/nestgpu_install
	# ./install.sh
	# chmod -R 777 $NEST_GPU

%runscript
	# Install nest from mount directory
	cd /opt/nest_install
	./install.sh

	# Install nestgpu from mount directory
	cd /opt/nestgpu_install
	./install.sh
